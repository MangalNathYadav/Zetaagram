{
  "rules": {
    "users": {
      ".read": "auth !== null",
      ".indexOn": ["username", "displayName"],
      "$uid": {
        ".read": "auth !== null",
        ".write": "auth !== null && auth.uid === $uid",
        ".validate": "newData.hasChildren(['username', 'email'])",
        "username": {
          ".validate": "newData.isString() && newData.val().length >= 3 && newData.val().length <= 30"
        },
        "email": {
          ".validate": "newData.isString() && newData.val().matches(/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$/)"
        },
        "photoURL": {
          ".validate": "newData.isString() || newData.val() === null"
        },
        "bio": {
          ".validate": "!newData.exists() || (newData.isString() && newData.val().length <= 150)"
        },
        "posts": {
          "$postId": {
            ".validate": "newData.isBoolean() && newData.val() === true"
          }
        },
        "following": {
          ".write": "auth !== null && auth.uid === $uid",
          "$followedUid": {
            ".validate": "newData.isBoolean() && newData.val() === true && $followedUid !== $uid"
          }
        },
        "followers": {
          ".write": "auth !== null",
          "$followerUid": {
            ".validate": "newData.isBoolean() && newData.val() === true && $followerUid !== $uid && auth.uid === $followerUid"
          }
        }
      }
    },
    "posts": {
      ".read": "auth !== null",
      ".write": "auth !== null",
      ".indexOn": ["timestamp", "userId"],
      "$postId": {
        ".write": "auth !== null",
        ".validate": "newData.hasChildren(['userId', 'caption', 'imageUrl', 'timestamp'])",
        "userId": {
          ".validate": "newData.isString() && (!data.exists() || data.val() === newData.val())"
        },
        "caption": {
          ".validate": "newData.isString() && newData.val().length <= 2000"
        },
        "imageUrl": {
          ".validate": "newData.isString()"
        },
        "timestamp": {
          ".validate": "newData.isString() && (!data.exists() || data.val() === newData.val())"
        },
        "likes": {
          ".validate": "newData.isNumber() && newData.val() >= 0"
        },
        "comments": {
          ".validate": "newData.isNumber() && newData.val() >= 0"
        },
        "likedBy": {
          "$uid": {
            ".write": "auth !== null && auth.uid === $uid",
            ".validate": "newData.isBoolean() && newData.val() === true"
          }
        },
        "commentsData": {
          ".write": "auth !== null",
          "$commentId": {
            ".validate": "newData.hasChildren(['userId', 'text', 'timestamp'])",
            "userId": {
              ".validate": "newData.isString() && newData.val() === auth.uid"
            },
            "text": {
              ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 500"
            },
            "timestamp": {
              ".validate": "newData.isString()"
            }
          }
        }
      }
    },
    "stories": {
      ".read": "auth !== null",
      "$uid": {
        ".write": "auth !== null && auth.uid === $uid",
        "$storyId": {
          ".validate": "newData.hasChildren(['imageUrl', 'timestamp'])",
          "imageUrl": {
            ".validate": "newData.isString()"
          },
          "timestamp": {
            ".validate": "newData.isString()"
          },
          "viewedBy": {
            "$viewerId": {
              ".write": "auth !== null && auth.uid === $viewerId",
              ".validate": "newData.isBoolean() && newData.val() === true"
            }
          }
        }
      }
    },
    "messages": {
      ".read": "auth !== null",
      ".write": "auth !== null",
      "$chatId": {
        ".read": "auth !== null && root.child('userChats').child($chatId).child('participants').child(auth.uid).exists()",
        ".write": "auth !== null && root.child('userChats').child($chatId).child('participants').child(auth.uid).exists()",
        "$messageId": {
          ".validate": "newData.hasChildren(['senderId', 'timestamp'])",
          "senderId": {
            ".validate": "newData.isString() && newData.val() === auth.uid"
          },
          "text": {
            ".validate": "!newData.exists() || newData.isString()"
          },
          "timestamp": {
            ".validate": "newData.isNumber()"
          },
          "imageUrl": {
            ".validate": "!newData.exists() || newData.isString()"
          }
        }
      }
    },
    "chats": {
      ".read": "auth !== null",
      "$chatId": {
        ".write": "auth !== null && (!data.exists() || data.child('participants').child(auth.uid).exists())",
        "participants": {
          "$uid": {
            ".validate": "newData.isBoolean() && newData.val() === true"
          }
        },
        "lastMessage": {
          ".validate": "newData.hasChildren(['text', 'timestamp', 'senderId'])"
        }
      }
    },
    "notifications": {
      "$uid": {
        ".read": "auth !== null && auth.uid === $uid",
        ".write": "auth !== null",
        "$notificationId": {
          ".validate": "newData.hasChildren(['type', 'senderId'])",
          "type": {
            ".validate": "newData.isString() && (newData.val() === 'like' || newData.val() === 'comment' || newData.val() === 'follow')"
          },
          "timestamp": {
            ".validate": "newData.isNumber() || newData.isString() || !newData.exists()"
          },
          "senderId": {
            ".validate": "newData.isString()"
          },
          "postId": {
            ".validate": "!newData.exists() || newData.isString()"
          },
          "commentId": {
            ".validate": "!newData.exists() || newData.isString()"
          }
        }
      }
    },
    "userChats": {
      ".read": "auth !== null",
      ".write": "auth !== null",
      "$chatId": {
        ".read": "auth !== null && (!data.exists() || data.child('participants').child(auth.uid).exists())",
        ".write": "auth !== null",
        "participants": {
          ".read": "auth !== null",
          ".write": "auth !== null"
        },
        "lastMessage": {
          ".read": "auth !== null && (!data.parent().exists() || data.parent().child('participants').child(auth.uid).exists())",
          ".write": "auth !== null && (!data.parent().exists() || data.parent().child('participants').child(auth.uid).exists())"
        },
        "lastTimestamp": {
          ".read": "auth !== null && (!data.parent().exists() || data.parent().child('participants').child(auth.uid).exists())",
          ".write": "auth !== null && (!data.parent().exists() || data.parent().child('participants').child(auth.uid).exists())",
          ".validate": "newData.isNumber() || !newData.exists()"
        },
        "unreadCount": {
          ".read": "auth !== null && (!data.parent().exists() || data.parent().child('participants').child(auth.uid).exists())",
          ".write": "auth !== null && (!data.parent().exists() || data.parent().child('participants').child(auth.uid).exists())"
        }
      }
    }
  }
}
