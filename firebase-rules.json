{
  "rules": {
    "users": {
      "$uid": {
        ".read": "auth !== null",
        ".write": "auth !== null && auth.uid === $uid",
        ".validate": "newData.hasChildren(['username', 'email'])",
        
        "username": {
          ".validate": "newData.isString() && newData.val().length >= 3 && newData.val().length <= 30"
        },
        
        "email": {
          ".validate": "newData.isString() && newData.val().matches(/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$/)"
        },
        
        "photoURL": {
          ".validate": "newData.isString() || newData.val() === null"
        },
        
        "bio": {
          ".validate": "!newData.exists() || (newData.isString() && newData.val().length <= 150)"
        },
        
        "posts": {
          "$postId": {
            ".validate": "newData.isBoolean() && newData.val() === true"
          }
        },
        
        "following": {
          "$followedUid": {
            ".validate": "newData.isBoolean() && newData.val() === true && $followedUid !== $uid"
          }
        },
        
        "followers": {
          "$followerUid": {
            ".validate": "newData.isBoolean() && newData.val() === true && $followerUid !== $uid"
          }
        }
      }
    },
    
    "posts": {
      ".read": "auth !== null",
      
      "$postId": {
        ".write": "auth !== null && (!data.exists() || data.child('userId').val() === auth.uid)",
        
        ".validate": "newData.hasChildren(['userId', 'caption', 'imageUrl', 'timestamp'])",
        
        "userId": {
          ".validate": "newData.isString() && (!data.exists() || data.val() === newData.val())"
        },
        
        "caption": {
          ".validate": "newData.isString() && newData.val().length <= 2000"
        },
        
        "imageUrl": {
          ".validate": "newData.isString()"
        },
        
        "timestamp": {
          ".validate": "newData.isString() && (!data.exists() || data.val() === newData.val())"
        },
        
        "likes": {
          ".validate": "newData.isNumber() && newData.val() >= 0"
        },
        
        "comments": {
          ".validate": "newData.isNumber() && newData.val() >= 0"
        },
        
        "likedBy": {
          "$uid": {
            ".write": "auth !== null && auth.uid === $uid",
            ".validate": "newData.isBoolean() && newData.val() === true"
          }
        },
        
        "commentsData": {
          ".write": "auth !== null",
          
          "$commentId": {
            ".validate": "newData.hasChildren(['userId', 'text', 'timestamp'])",
            
            "userId": {
              ".validate": "newData.isString() && newData.val() === auth.uid"
            },
            
            "text": {
              ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 500"
            },
            
            "timestamp": {
              ".validate": "newData.isString()"
            }
          }
        }
      }
    },
    
    "stories": {
      ".read": "auth !== null",
      
      "$uid": {
        ".write": "auth !== null && auth.uid === $uid",
        
        "$storyId": {
          ".validate": "newData.hasChildren(['imageUrl', 'timestamp'])",
          
          "imageUrl": {
            ".validate": "newData.isString()"
          },
          
          "timestamp": {
            ".validate": "newData.isString()"
          },
          
          "viewedBy": {
            "$viewerId": {
              ".write": "auth !== null && auth.uid === $viewerId",
              ".validate": "newData.isBoolean() && newData.val() === true"
            }
          }
        }
      }
    },
    
    "messages": {
      "$chatId": {
        ".read": "auth !== null && root.child('chats').child($chatId).child('participants').child(auth.uid).exists()",
        
        ".write": "auth !== null && root.child('chats').child($chatId).child('participants').child(auth.uid).exists()",
        
        "$messageId": {
          ".validate": "newData.hasChildren(['senderId', 'text', 'timestamp'])",
          
          "senderId": {
            ".validate": "newData.isString() && newData.val() === auth.uid"
          },
          
          "text": {
            ".validate": "newData.isString() && newData.val().length > 0"
          },
          
          "timestamp": {
            ".validate": "newData.isString()"
          },
          
          "imageUrl": {
            ".validate": "!newData.exists() || newData.isString()"
          }
        }
      }
    },
    
    "chats": {
      ".read": "auth !== null",
      
      "$chatId": {
        ".write": "auth !== null && (!data.exists() || data.child('participants').child(auth.uid).exists())",
        "participants": {
          "$uid": {
            ".validate": "newData.isBoolean() && newData.val() === true"
          }
        },
        "lastMessage": {
          ".validate": "newData.hasChildren(['text', 'timestamp', 'senderId'])"
        }
      }
    },
    
    "notifications": {
      "$uid": {
        ".read": "auth !== null && auth.uid === $uid",
        
        ".write": "auth !== null",
        
        "$notificationId": {
          ".validate": "newData.hasChildren(['type', 'timestamp', 'senderId'])",
          
          "type": {
            ".validate": "newData.isString() && (newData.val() === 'like' || newData.val() === 'comment' || newData.val() === 'follow')"
          },
          
          "senderId": {
            ".validate": "newData.isString() && newData.val() === auth.uid"
          },
          
          "postId": {
            ".validate": "!newData.exists() || newData.isString()"
          },
          
          "commentId": {
            ".validate": "!newData.exists() || newData.isString()"
          }
        }
      }
    }
  }
}
